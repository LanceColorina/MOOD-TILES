<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Spotify Listening History</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>
<body>
        {% if session.user_id and page >= 1 %}
        <div class="modal-overlay" id="aboutModal" style="display: none;">

        <div class="about-app">
            <span class="close-modal" onclick="closeAboutModal()">&times;</span>
            <h2>About Mood Tiles</h2>
            <p>
                <strong>MOOD Tiles</strong> is a personalized music reflection tool that helps you visualize your Spotify listening history. 
                By analyzing your recent and current tracks, the app offers insights into your musical moods through color-coded "tiles."
            </p>
            <p>
                This project is designed to blend music data with mood representation‚Äîbringing emotion and style to your listening experience.
            </p>
        </div>
        </div>
        {% endif %}
        
  <div class="music-container">
    <!-- NOW PLAYING -->
    <div class="music-section now-playing">
        <button class="refresh-button" onclick="refreshCurrentSong()" title="Refresh">
        <i class="fas fa-arrows-rotate"></i>
        </button>
        <div class="now-playing-content">
        <h1 class="app-title">
            <span class="mood-m">M</span>
            <span class="mood-o1">O</span>
            <span class="mood-o2">O</span>
            <span class="mood-d">D</span>
            <span class="mood-tiles"> Tiles</span>
        </h1>
        <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üéß Now Playing</h2>
        </div>
      {% if current_song %}
      <div class="current-track {{ current_song.mood }}">
        <div class="album-art ">
          {% if current_song.image %}
          <img src="{{ current_song.image }}" alt="Album cover">
          {% endif %}
        </div>
        <div class="track-details">
          <strong>{{ current_song.name }}</strong><br>
          <span class="artist">{{ current_song.artist }}</span><br>
          <a href="{{ current_song.url }}" target="_blank">Open in Spotify ‚Üó</a>
          <div class="mood-selector-container">
            <span class="current-mood-label">Mood:</span>
            {% if current_song.track_id %}
            <select class="mood-dropdown" onchange="updateMood({{ current_song.track_id }}, this.value)">
              {% for mood in available_moods %}
              <option value="{{ mood }}" {% if mood == current_song.mood %}selected{% endif %}>{{ mood }}</option>
              {% endfor %}
            </select>
            {% else %}
            <span class="mood-display">{{ current_song.mood }}</span>
            {% endif %}
          </div>
        </div>
        <div class="music-bars">
          <span></span><span></span><span></span><span></span>
        </div>
      </div>
      {% else %}
      <p>No song currently playing.</p>
      {% endif %}
 
      </div>
        <div class="logout-section">
        <a class="logout-btn" href="{{ url_for('logout') }}">Logout from Spotify</a>
        </div>
    </div>

    <!-- DIVIDER -->
    <div class="divider"></div>

    <!-- RECENTLY PLAYED -->
    <div class="music-section recently-played">
     <button class="about-button" onclick="openAboutModal()" title="About this app">
            <i class="fas fa-circle-info"></i>
        </button>
    <h1>Spotify Recently Played</h1>
    {% if songs %}
        <a class="check" onclick="openMonthlyModal()">Check your monthly mood ‚ûú</a>
        <div class="song-list">
        {% for song in songs %}
        <div class="song-card {{ song.mood }}" id="song-card-{{ song.track_id }}">
            <div class="song-card-header">
                <div class="song-title">{{ song.name }}</div>
                {% if song.url %}
                    <a class="song-link-inline" href="{{ song.url }}" target="_blank">‚ñ∂ Spotify</a>
                {% endif %}
            </div>
            <div class="song-artist">by {{ song.artist }}</div>
            
            <div class="mood-selector-container">
                <span class="song-mood-label">Mood:</span>
                <select class="mood-dropdown" onchange="updateMood({{ song.track_id }}, this.value)">
                    {% for mood in available_moods %}
                    <option value="{{ mood }}" {% if mood == song.mood %}selected{% endif %}>{{ mood }}</option>
                    {% endfor %}
                </select>
                {% if song.is_custom_mood %}
                <span class="custom-mood-indicator" title="Custom mood">‚ú®</span>
                {% endif %}
            </div>
            
            <div class="song-played-at">Played at {{ song.played_at }}</div>
        </div>
        {% endfor %}
        </div>

        <div class="pagination">
        <div class="page-indicator">Page {{ page }} of {{ total_pages }}</div>
        <div class="pagination-buttons">
            {% if page > 1 %}
            <a href="{{ url_for('recent') }}?page={{ page - 1 }}">‚Üê Previous</a>
            {% endif %}
            {% if page < total_pages %}
            <a href="{{ url_for('recent') }}?page={{ page + 1 }}">Next ‚Üí</a>
            {% endif %}
        </div>
        </div>
    {% endif %}

        <div id="monthlyModalOverlay" class="modal-overlay" style="display: none;">
            <div class="monthlymodal-content" id="monthlyModal">
                <span class="monthlyclose" onclick="closeMonthlyModal()">&times;</span>
                <div class="modal-body">
                    <h2 class="spotify-font">Select a Month</h2>
                    <form method="POST" action="{{ url_for('monthly') }}">
                        <label class="spotify-font" for="month">Month:</label>
                        <input type="month" name="month" required>
                        <button type="submit" class="analyze-button" style="margin-top: 10px;">Analyze</button>
                    </form>
                </div>
            </div>
        </div>

    <!-- Loading Spinner (hidden by default) -->
    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
        <div class="spinner"></div>
        <p>Updating mood...</p>
    </div>

  </div>
</body>
{% if show_modal %}
<script>
  window.onload = function () {
    openAboutModal();
  };
</script>
{% endif %}
<script>

function closeAboutModal() {
    const modal = document.getElementById('aboutModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function openAboutModal() {
    const modal = document.getElementById('aboutModal');
    if (modal) {
        modal.style.display = 'flex';  // not block!
    }
}

function updateMood(trackId, newMood) {
    // Show loading spinner
    document.getElementById('loadingSpinner').style.display = 'flex';
    
    fetch('/update-mood', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            track_id: trackId,
            mood: newMood
        })
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading spinner
        document.getElementById('loadingSpinner').style.display = 'none';
        
        if (data.success) {
            // Update the song card's CSS class to reflect new mood
            const songCard = document.getElementById('song-card-' + trackId);
            if (songCard) {
                // Remove all existing mood classes
                const moodClasses = ['Angry üò†', 'Energetic üî•', 'Happy üòä', 'Chill üòé', 'Calm üßò', 'Sad üò¢', 'Depressed üòû', 'Unknown ü§∑'];
                moodClasses.forEach(mood => {
                    songCard.classList.remove(mood.replace(' ', '-').replace('üò†', '').replace('üî•', '').replace('üòä', '').replace('üòé', '').replace('üßò', '').replace('üò¢', '').replace('üòû', '').replace('ü§∑', '').trim());
                });
                
                // Add new mood class (simplified class name)
                const simplifiedMood = newMood.split(' ')[0].toLowerCase();
                songCard.classList.add(simplifiedMood);
                
                // Add custom mood indicator if it doesn't exist
                const moodContainer = songCard.querySelector('.mood-selector-container');
                let customIndicator = moodContainer.querySelector('.custom-mood-indicator');
                if (!customIndicator) {
                    customIndicator = document.createElement('span');
                    customIndicator.className = 'custom-mood-indicator';
                    customIndicator.title = 'Custom mood';
                    customIndicator.textContent = '‚ú®';
                    moodContainer.appendChild(customIndicator);
                }
            }
            
            // Show success message
            showNotification('Mood updated successfully!', 'success');
        } else {
            // Show error message
            showNotification('Error updating mood: ' + (data.error || 'Unknown error'), 'error');
            
            // Revert dropdown to original value
            const dropdown = document.querySelector(`select[onchange*="${trackId}"]`);
            if (dropdown) {
                // You might want to store the original value somewhere
                console.log('Failed to update mood, consider reverting dropdown');
            }
        }
    })
    .catch(error => {
        // Hide loading spinner
        document.getElementById('loadingSpinner').style.display = 'none';
        
        console.error('Error updating mood:', error);
        showNotification('Network error occurred', 'error');
    });
}


// Notification system
function showNotification(message, type) {
    // Remove existing notifications
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Show notification
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    // Hide notification after 3 seconds
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Monthly modal functionality
function openMonthlyModal() {
    document.getElementById('monthlyModalOverlay').style.display = 'flex';
}

function closeMonthlyModal() {
    document.getElementById('monthlyModalOverlay').style.display = 'none';
}

// Enhanced click-outside-to-close for both modals
window.onclick = function(event) {
    const monthlyOverlay = document.getElementById('monthlyModalOverlay');
    const aboutOverlay = document.getElementById('aboutModal');
    
    if (event.target === monthlyOverlay) {
        closeMonthlyModal();
    }
    
    if (event.target === aboutOverlay) {
        closeAboutModal();
    }
}

function refreshCurrentSong() {
    // Reload the /recent page to update the "Now Playing" section
    location.reload();
}



</script>
</html>